<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Spotify Sonos Controller</title>
<style>
body { font-family: Arial; text-align:center; background:#121212; color:white; margin:0; padding:0;}
#track { margin-top:10px; font-size:18px; }
button {
  padding: 20px 30px;
  margin: 5px;
  font-size: 20px;
  border-radius: 10px;
  background-color: #1db954;
  color: white;
  border: none;
}
img { width: 200px; margin-top: 20px; border-radius: 10px; }
input[type=range] { width: 80%; margin: 20px 0; }
</style>
</head>
<body>

<h1>Spotify Sonos Controller</h1>

<img id="cover" src="" alt="Album Cover">
<div id="track"></div>

<div>
  <button onclick="play()">▶ Play</button>
  <button onclick="pause()">⏸ Pause</button>
  <button onclick="prev()">⏮ Prev</button>
  <button onclick="next()">⏭ Next</button>
</div>

<div>
  Lautstärke: <input type="range" id="volume" min="0" max="100" value="50" onchange="setVolume(this.value)">
</div>

<script>
const clientId = "ce0298d909dd4c5486edb32134a25c19"; // Spotify Client ID
const redirectUri = "https://cr0sscu7.github.io/spotify-controller/";
const scopes = "user-read-playback-state user-modify-playback-state user-read-currently-playing";

let accessToken = null;
let deviceId = null; // automatisch Sonos Device auswählen

// PKCE Helper
function generateRandomString(length){
  const possible='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  return Array.from(crypto.getRandomValues(new Uint8Array(length)))
    .map(x=>possible[x%possible.length]).join('');
}
async function sha256(plain){
  const encoder=new TextEncoder();
  const data=encoder.encode(plain);
  return await crypto.subtle.digest('SHA-256', data);
}
function base64urlencode(a){
  return btoa(String.fromCharCode(...new Uint8Array(a)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

// Login
async function login(){
  const codeVerifier=generateRandomString(64);
  localStorage.setItem("verifier", codeVerifier);
  const hashed=await sha256(codeVerifier);
  const codeChallenge=base64urlencode(hashed);

  const authUrl=`https://accounts.spotify.com/authorize?response_type=code&client_id=${clientId}&scope=${encodeURIComponent(scopes)}&redirect_uri=${encodeURIComponent(redirectUri)}&code_challenge_method=S256&code_challenge=${codeChallenge}`;
  window.location=authUrl;
}

// Token
async function getToken(code){
  const verifier=localStorage.getItem("verifier");
  const body=new URLSearchParams({
    client_id:clientId,
    grant_type:"authorization_code",
    code:code,
    redirect_uri:redirectUri,
    code_verifier:verifier
  });
  const response=await fetch("https://accounts.spotify.com/api/token",{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:body
  });
  const data=await response.json();
  accessToken=data.access_token;
  await selectSonos();
}

// API Wrapper
function api(url,method="GET"){ 
  const headers={"Authorization":"Bearer "+accessToken};
  return fetch(url,{method,headers});
}

// Steuerfunktionen
function play(){ if(deviceId) api(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`,"PUT"); }
function pause(){ if(deviceId) api(`https://api.spotify.com/v1/me/player/pause?device_id=${deviceId}`,"PUT"); }
function next(){ if(deviceId) api(`https://api.spotify.com/v1/me/player/next?device_id=${deviceId}`,"POST"); }
function prev(){ if(deviceId) api(`https://api.spotify.com/v1/me/player/previous?device_id=${deviceId}`,"POST"); }
function setVolume(val){ if(deviceId) api(`https://api.spotify.com/v1/me/player/volume?volume_percent=${val}&device_id=${deviceId}`,"PUT"); }

// Sonos automatisch auswählen
async function selectSonos(){
  const res=await api("https://api.spotify.com/v1/me/player/devices");
  const data=await res.json();
  const sonos=data.devices.find(d=>d.name.toLowerCase().includes("sonos"));
  if(sonos) deviceId=sonos.id;
}

// Track aktualisieren
async function getTrack(){
  try{
    if(!deviceId) await selectSonos();
    const res=await api("https://api.spotify.com/v1/me/player/currently-playing");
    const data=await res.json();
    if(data && data.item){
      document.getElementById("track").innerText=data.item.name+" - "+data.item.artists.map(a=>a.name).join(", ");
      document.getElementById("cover").src=data.item.album.images[0].url;
      document.getElementById("volume").value=data.device.volume_percent;
    }
  } catch(e){
    console.log("Kein Track oder Token abgelaufen");
  }
}

const params=new URLSearchParams(window.location.search);
const code=params.get("code");
if(code){
  getToken(code).then(()=>{ setInterval(getTrack,3000); });
}
</script>

</body>
</html>
